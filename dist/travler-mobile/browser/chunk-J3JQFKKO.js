import{a as ge}from"./chunk-E45YUQWY.js";import{a as he}from"./chunk-3HZLL5PW.js";import{a as Fe}from"./chunk-JPC3RVDF.js";import{a as be}from"./chunk-3DMRJL5X.js";import{a as ve}from"./chunk-D5BAB7TU.js";import"./chunk-SQM2R4FL.js";import{a as ue}from"./chunk-D3BB2YUO.js";import"./chunk-ZRTNA5AZ.js";import"./chunk-ZGVWO2O4.js";import{g as X,l as ye}from"./chunk-NMHFSZUN.js";import"./chunk-4QCEHMDE.js";import{a as fe}from"./chunk-LF2IBCJR.js";import"./chunk-KLFOQ2RT.js";import{A as ce,B as de,b as Z,c as ee,d as c,f as te,g as ie,l as ne,n as oe,p as re,q as ae,r as me,s as le,t as pe,z as se}from"./chunk-RAZRMRQX.js";import"./chunk-7UZYWCAJ.js";import"./chunk-6LBJZWJB.js";import{i as z,j as U,k as H,q as J,v as Q}from"./chunk-GPQBVM7U.js";import{c as Y}from"./chunk-35RUP4P6.js";import{C as V,Cc as K,Dc as M,H as D,Ic as m,Jc as l,M as A,Ob as u,Pb as t,Qb as n,Rb as f,S as L,U as q,_a as i,bc as g,ea as I,k as S,lb as v,o as k,pc as $,qb as R,rc as a,sc as b,tc as C,uc as _,wb as B,wc as j,x as O,xc as W,yc as G,z as F,zc as x}from"./chunk-45NCVV7C.js";import{a as E,b as N,h as ke,j as T}from"./chunk-TWZW5B45.js";var y=ke(Fe());var _e=d=>({"border-success bg-light":d}),xe=d=>({"border-danger bg-light":d}),Pe=()=>({height:"700px"});function we(d,e){if(d&1&&(t(0,"option",44),a(1),n()),d&2){let r=e.$implicit;u("value",r.code),i(),C(" +",r.code," ")}}function Te(d,e){d&1&&(t(0,"div",45),a(1," Please enter a valid mobile number. "),n())}var Ce=class d{constructor(e,r,o,p){this.fb=e;this.bookingService=r;this.service=o;this.toastr=p;this.bookingService.referenceNumber$.subscribe(h=>{})}paymentForm;promotionForm;interval;isTimeExpired=!1;selectedPaymentMethod="mpesa";timeLeft=600;totalDuration=600;countryCodes=[{code:"254",country:"Kenya"},{code:"255",country:"Tanzania"},{code:"256",country:"Uganda"},{code:"250",country:"Rwanda"}];router=I(X);paymentSocketService=I(ge);ngOnInit(){this.paymentForm=this.fb.group({paymentMethod:["mpesa",c.required],mobileNumber:["",[c.required]],consent:[!0,[c.requiredTrue]],countryCode:["",c.required]}),this.promotionForm=this.fb.group({code:["",c.required]}),this.getTicket(),this.restoreTimer()}getTicket(){return T(this,null,function*(){{let e=yield this.bookingService.getConfig("ticket");this.paymentForm.patchValue({countryCode:e.ticketDetail.onwardticket.passenger[0].mobileId,mobileNumber:e.ticketDetail.onwardticket.passenger[0].mobile})}})}updatePlaceholder(){this.selectedPaymentMethod=this.paymentForm.value.paymentMethod;let e=this.paymentForm.get("mobileNumber");this.selectedPaymentMethod==="mpesa"?(e?.setValidators([c.required,c.pattern(/^7\d{8}$/)]),e?.updateValueAndValidity()):(e?.setValidators([c.required,c.pattern(/^7\d{8}$/)]),e?.updateValueAndValidity())}startTimer(){this.interval&&clearInterval(this.interval),this.isTimeExpired=!1,this.bookingService.setConfig("timerStart",Date.now().toString()),this.interval=setInterval(()=>{let e=Number(this.bookingService.getConfig("timerStart")),r=Math.floor((Date.now()-e)/1e3);this.timeLeft=Math.max(0,this.totalDuration-r),this.bookingService.setConfig("timeLeft",this.timeLeft.toString()),this.timeLeft===0&&(clearInterval(this.interval),this.isTimeExpired=!0,this.bookingService.removeConfig("timeLeft"),this.bookingService.removeConfig("timerStart"),this.onTimeExpired())},1e3)}onTimeExpired(){console.log("Time has expired!")}restoreTimer(){let e=this.bookingService.getConfig("timeLeft");e&&(this.timeLeft=Number(e),this.timeLeft>0&&this.startTimer())}get formattedTime(){let e=Math.floor(this.timeLeft/60),r=this.timeLeft%60;return`${e}:${r<10?"0":""}${r}`}busInfoVisible=!0;submitPayment(){if(this.paymentForm.invalid){this.paymentForm.markAllAsTouched();return}if(this.isTimeExpired){alert("Time expired! Please refresh and try again.");return}this.makePayment()}updateValidation(){let e=this.paymentForm.get("countryCode")?.value,r=this.paymentForm.get("mobileNumber");e?r?.setValidators([c.required]):r?.setValidators([c.required,c.pattern(/^07\d{8}$/)]),r?.updateValueAndValidity()}makePayment(){return T(this,null,function*(){let e=this.paymentForm.value,o={bookingRef:yield this.bookingService.getConfig("booking_reference"),queryoption:2,queryvalue:e.countryCode+e.mobileNumber,requestType:"ticket",additionalInfo:{onward:{sponsorTrip:!1,discountId:0},return:{sponsorTrip:!1,discountId:0}},isWalletApply:!1,sourcetype:"web"};this.checkWallet().subscribe(p=>{let h=N(E({},o),{isWalletApply:p});this.service.makePayment(h).subscribe(P=>{let w=h.bookingRef;this.startTimer(),P.isSuccess?(y.default.fire({icon:"success",title:"Payment Initiated",text:P.msg,timer:3e3,showConfirmButton:!1}),setTimeout(()=>{this.paymentSocketService.isConnected$.pipe(F(s=>s),D(1),q(()=>{y.default.fire({title:"Processing Payment",text:"Please complete the payment on your phone...",icon:"info",allowOutsideClick:!1,showConfirmButton:!1,didOpen:()=>{y.default.showLoading()}}),this.paymentSocketService.joinPaymentRoom(w)}),L(()=>O(this.paymentSocketService.paymentConfirmation$.pipe(F(s=>s!==null),k(s=>({type:"payment",data:s}))),this.paymentSocketService.roomTimeout$.pipe(F(s=>s!==null),k(s=>({type:"timeout",data:s})))).pipe(A()))).subscribe({next:s=>{y.default.close(),s.type==="payment"?y.default.fire({title:"Payment Successful!",text:`Payment of KES ${s.data.data.TransAmount} received`,icon:"success",confirmButtonText:"OK"}).then(()=>{this.router.navigate(["/feedback"])}):s.type==="timeout"&&y.default.fire({title:"Payment Timeout",text:"Payment window has expired. Please try again.",icon:"error",confirmButtonText:"Retry"}).then(Se=>{Se.isConfirmed&&(this.paymentSocketService.leavePaymentRoom(w),this.paymentSocketService.disconnect(),this.makePayment())}),this.paymentSocketService.leavePaymentRoom(w)},error:s=>{y.default.close(),y.default.fire({title:"Error",text:"Something went wrong. Please try again.",icon:"error",confirmButtonText:"OK"})}})},3e3)):y.default.fire({icon:"error",title:"Payment Failed",text:P.msg,confirmButtonText:"OK"})})})})}checkWallet(){let e=this.bookingService.getConfig("userData");return e?e.userId?this.service.getUserWalletData(e.userId).pipe(k(r=>r.data.amount>=1),V(r=>(console.log(r),S(!1)))):S(!1):S(!1)}static \u0275fac=function(r){return new(r||d)(v(se),v(ye),v(fe),v(he))};static \u0275cmp=R({type:d,selectors:[["app-checkout-payment-form"]],decls:91,vars:75,consts:[[1,"section"],[1,"container"],[1,"text-end","p-2"],["icon","bi bi-info-circle","styleClass","bg-custom p-button-sm mt-2",3,"click","label"],[1,"row"],[1,"col-12","col-md-6","col-lg-8","vstack","gap-2"],[1,"card","shadow-sm","border-0","rounded-3","p-4","h-100"],[1,"d-flex","justify-content-between","align-items-center","mb-4"],[1,"fw-bold","mb-0"],[1,"badge","bg-danger","text-white","rounded-pill","px-3","py-2","small"],[1,"needs-validation",3,"formGroup"],[1,"mb-4"],[1,"form-label","fw-semibold"],[1,"d-flex","gap-3"],[1,"flex-fill","border","rounded-3","p-2","text-center","cursor-pointer",3,"ngClass"],["type","radio","formControlName","paymentMethod","id","mpesa","value","mpesa",1,"d-none",3,"change"],["src","assets/mpesa.png","alt","Mpesa","width","80",1,"mb-1"],[1,"fw-bold","small"],["type","radio","formControlName","paymentMethod","id","airtel","value","airtel",1,"d-none",3,"change"],["src","assets/airtel.png","alt","Airtel Money","width","80",1,"mb-1"],[1,"input-group"],["formControlName","countryCode",1,"form-select","flex-shrink-0",2,"max-width","110px",3,"change"],["value",""],[3,"value",4,"ngFor","ngForOf"],["type","tel","placeholder","700 000 000","formControlName","mobileNumber",1,"form-control"],["class","invalid-feedback",4,"ngIf"],["data-bs-toggle","collapse","href","#voucherCollapse",1,"text-decoration-none","text-primary"],[1,"bi","bi-ticket-perforated","me-1"],["id","voucherCollapse",1,"collapse","mt-2"],["type","text",1,"form-control","rounded-2",3,"placeholder"],["type","button",1,"btn","btn-outline-success","rounded-2"],[1,"alert","alert-warning","d-flex","align-items-center","py-2"],[1,"bi","bi-exclamation-triangle-fill","me-2"],[1,"small"],[1,"form-check","mb-4","small"],["type","checkbox","formControlName","consent","id","consentCheck",1,"form-check-input"],["for","consentCheck",1,"form-check-label"],["href","#","target","_blank"],[1,"d-flex","justify-content-end"],[1,"btn","btn-success","py-2","px-4","rounded-pill","fs-6","fw-semibold","shadow","w-100",3,"click","disabled"],[1,"bi","bi-lock-fill","me-2"],["position","bottom",1,"p-2",3,"visibleChange","header","visible"],[1,"mt-2"],[1,"btn","btn-success","py-2","px-4","rounded-pill","custom-btn","fs-6","fw-semibold","shadow","w-100",3,"click"],[3,"value"],[1,"invalid-feedback"]],template:function(r,o){if(r&1&&(t(0,"div",0)(1,"div",1)(2,"div",2)(3,"p-button",3),m(4,"translate"),g("click",function(){return o.busInfoVisible=!0}),n()(),t(5,"div",4)(6,"div",5)(7,"div",6)(8,"div")(9,"div",7)(10,"h4",8),a(11),m(12,"translate"),n(),t(13,"span",9),a(14),m(15,"translate"),n()(),t(16,"form",10)(17,"div",11)(18,"label",12),a(19),m(20,"translate"),n(),t(21,"div",13)(22,"label",14)(23,"input",15),g("change",function(){return o.updatePlaceholder()}),n(),f(24,"img",16)(25,"br"),t(26,"span",17),a(27),m(28,"translate"),n()(),t(29,"label",14)(30,"input",18),g("change",function(){return o.updatePlaceholder()}),n(),f(31,"img",19)(32,"br"),t(33,"span",17),a(34),m(35,"translate"),n()()()(),t(36,"div",11)(37,"label",12),a(38),m(39,"translate"),n(),t(40,"div",20)(41,"select",21),g("change",function(){return o.updateValidation()}),t(42,"option",22),a(43,"+Code"),n(),B(44,we,2,2,"option",23),n(),f(45,"input",24),n(),B(46,Te,2,0,"div",25),n(),t(47,"div",11)(48,"a",26),f(49,"i",27),a(50),m(51,"translate"),n(),t(52,"div",28)(53,"div",20),f(54,"input",29),m(55,"translate"),t(56,"button",30),a(57),m(58,"translate"),n()()()(),t(59,"div",31),f(60,"i",32),t(61,"span",33),a(62),m(63,"translate"),n()(),t(64,"div",34),f(65,"input",35),t(66,"label",36),a(67),m(68,"translate"),t(69,"a",37),a(70),m(71,"translate"),n(),a(72," and "),t(73,"a",37),a(74),m(75,"translate"),n(),a(76,". "),n()(),t(77,"div",38)(78,"button",39),g("click",function(){return o.submitPayment()}),f(79,"i",40),a(80),m(81,"translate"),m(82,"titlecase"),n()()()()()()()()(),t(83,"p-drawer",41),m(84,"translate"),G("visibleChange",function(h){return W(o.busInfoVisible,h)||(o.busInfoVisible=h),h}),f(85,"app-checkout-bus-info"),t(86,"div",42)(87,"button",43),g("click",function(){return o.busInfoVisible=!1}),a(88),m(89,"translate"),m(90,"titlecase"),n()()()),r&2){let p;i(3),u("label",x(l(4,32,"paymentForm.viewBusInfo"))),i(8),b(l(12,34,"paymentForm.paymentDetails")),i(3),_(" \u23F1 ",o.formattedTime," ",l(15,36,"paymentForm.remainingTime")," "),i(2),u("formGroup",o.paymentForm),i(3),b(l(20,38,"paymentForm.selectPaymentMethod")),i(3),u("ngClass",M(70,_e,o.paymentForm.value.paymentMethod==="mpesa")),i(5),b(l(28,40,"paymentForm.mpesa")),i(2),u("ngClass",M(72,xe,o.paymentForm.value.paymentMethod==="airtel")),i(5),b(l(35,42,"paymentForm.airtelMoney")),i(4),b(l(39,44,"paymentForm.phoneNumber")),i(6),u("ngForOf",o.countryCodes),i(2),u("ngIf",((p=o.paymentForm.get("mobileNumber"))==null?null:p.invalid)&&((p=o.paymentForm.get("mobileNumber"))==null?null:p.touched)),i(4),C(" ",l(51,46,"paymentForm.voucher")," "),i(4),u("placeholder",x(l(55,48,"paymentForm.voucherPlaceholder"))),i(3),C(" ",l(58,50,"paymentForm.apply")," "),i(5),b(l(63,52,"paymentForm.note")),i(5),C(" ",l(68,54,"paymentForm.consent")," "),i(3),b(l(71,56,"paymentForm.privacyPolicy")),i(4),b(l(75,58,"paymentForm.termsConditions")),i(4),u("disabled",o.isTimeExpired||o.paymentForm.invalid),i(2),_(" ",l(81,60,"paymentForm.paySecurely")," ",l(82,62,o.paymentForm.value.paymentMethod)," "),i(3),$(K(74,Pe)),u("header",x(l(84,64,"paymentForm.viewBusInfo"))),j("visible",o.busInfoVisible),i(5),_(" ",l(89,66,"paymentForm.paySecurely")," ",l(90,68,o.paymentForm.value.paymentMethod)," ")}},dependencies:[Q,z,U,H,de,ne,le,pe,ee,Z,me,oe,te,ie,re,ae,ce,be,ue,ve,J,Y],styles:[".app-container[_ngcontent-%COMP%]{min-height:90vh}.form-control[_ngcontent-%COMP%], .form-select[_ngcontent-%COMP%], input-group-text[_ngcontent-%COMP%]{border:1px solid #ddd;border-radius:.375rem;padding:.5rem;background-color:#efefef}.form-label[_ngcontent-%COMP%]{font-weight:500;margin-bottom:.5rem}h5[_ngcontent-%COMP%]{font-weight:600;font-size:1.25rem;color:#454545}.badge[_ngcontent-%COMP%]{background-image:linear-gradient(to right,var(--primary-color-400),var(--primary-color-500),var(--primary-color-600),var(--primary-color-600))}.card-body[_ngcontent-%COMP%]{padding:.5rem 1rem}.card[_ngcontent-%COMP%]{background:#fff;border-radius:12px}.section-title[_ngcontent-%COMP%]   h5[_ngcontent-%COMP%]{font-weight:600}@media (min-width: 992px){.card[_ngcontent-%COMP%]{min-height:100%}}[_nghost-%COMP%]     .bg-custom{background:linear-gradient(45deg,var(--primary-color-500),var(--primary-color-400));border:1px solid var(--primary-color-500)}"]})};export{Ce as PaymentFormComponent};
