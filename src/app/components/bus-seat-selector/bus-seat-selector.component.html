<div class="bus-container" [@busLayout]>
  <div class="card shadow-none bg-success" [style.maxWidth.px]="1000">
    <div 

    class="card-body ">
      <div class="">
        <div class="d-flex justify-content-between align-items-start">
          <div class="d-none flex-grow-1 d-lg-flex flex-column align-items-start ">
            <p
              class="fs-6 text-muted fw-semibold mb-0 d-flex align-items-center">
              {{ busData.company_name }}
            </p>
          </div>

        </div>
      </div>
      <h5 class="card-title d-flex justify-content-between align-items-center mb-2">
        <span
          style="font-size: 1rem;"
          class="text-muted">Select Your Seats</span>
        <span class="badge">{{ selectedSeats.length }}/6 Selected</span>
      </h5>

      <!-- Bus Layout Container -->
      <div #busContainer class="bus-layout" [style.maxHeight.px]="busLayoutHeight">
        <!-- Visual outline of the bus -->
        <div class="bus-outline bg-light"></div>

        <!-- Overlay for mobile orientation message -->
        <div class="orientation-message" *ngIf="isMobileView" [@fadeIn]>
          <i class="bi bi-phone-flip"></i>
          <small>Vertical layout for mobile</small>
        </div>

        <!-- Seats -->
        <ng-container *ngFor="let seat of seatData">
          <!-- Regular Seats -->
          <button *ngIf="seat.seat_type !== 'driver' && seat.seat_type !== 'door'"
                  class="m-1"
                  [class]="'seat ' + getSeatClass(seat)"
                  [@seatState]="getSeatState(seat)"
                  [class.selected]="isSelected(seat)"
                  [style.left.px]="adjustSeatPosition(seat, 'left')"
                  [style.top.px]="adjustSeatPosition(seat, 'top')"
                  [style.width.px]="parseInt(seat.seat_width) * cardScaleFactor"
                  [style.height.px]="parseInt(seat.seat_height) * cardScaleFactor"
                  [style.fontSize.px]="14 * cardScaleFactor"
                  [disabled]="seat.selection_status || seat.seat_type == 'staff' "
                  (click)="toggleSeat(seat)"
                  [attr.aria-label]="'Seat ' + seat.seat_name + ' - ' + seat.seat_type">
            {{ seat.seat_name }}
            <div class="seat-tooltip" *ngIf="isSelected(seat)" [@tooltip]="'visible'">
              <i class="bi bi-check"></i>
            </div>
          </button>

          <!-- <div *ngIf="seat.seat_type === 'driver' || seat.seat_type === 'door'"
               [class]="seat.seat_type === 'driver' ? 'driver-section' : 'door-section'"
               [style.left.px]="adjustSeatPosition(seat, 'left')"
               [style.top.px]="adjustSeatPosition(seat, 'top')"
               [style.width.px]="seat.seat_width"
               [style.height.px]="seat.seat_height">
            <i [class]="seat.seat_type === 'driver' ? 'bi bi-gear' : 'bi bi-door-open'"></i>
            <small>{{ seat.seat_type === 'driver' ? 'Driver' : 'Entry/Exit' }}</small>
          </div> -->

          <div *ngIf="seat.seat_type === 'door'"
               class="door-section bus-name"
               [style.left.px]="adjustSeatPosition(seat, 'left')"
               [style.top.px]="adjustSeatPosition(seat, 'top')"
               [style.width.px]="parseInt(seat.seat_width) * cardScaleFactor"
               [style.height.px]="parseInt(seat.seat_height) * cardScaleFactor"
               [style.fontSize.rem]="0.8 * scaleFactor"
          >
            <div
              class="ms-1"
              style=" line-height: 36px; border: 2px dashed rgb(232, 232, 232); text-align: center; color: rgb(232, 232, 232); text-transform: uppercase; "
              [style.width.px]="90 * cardScaleFactor"
              [style.height.px]="36 * cardScaleFactor"
             [style.lineHeight.px]="36 * cardScaleFactor"
              [style.fontSize.px]="18 * scaleFactor"

            >
              <span style="font-size: 14px;color: #969696" class="ng-binding">Door</span>
            </div>
          </div>


          <div *ngIf="seat.seat_type === 'driver'"
               class="door-section bus-name"
               [style.left.px]="adjustSeatPosition(seat, 'left')"
               [style.top.px]="adjustSeatPosition(seat, 'top')"
               [style.width.px]="parseInt(seat.seat_width) * cardScaleFactor"
               [style.height.px]="90 * cardScaleFactor">
            <svg version="1.1" xmlns="http://www.w3.org/2000/svg" width="50" height="50" >
              <path d="M0 0 C4.8404001 2.60960701 8.06650639 6.09014417 9.796875 11.28125 C10.46163179 18.73524418 10.44121145 24.25616487 5.796875 30.28125 C0.39692227 35.28608423 -4.05234248 35.63143872 -11.1875 35.5625 C-16.73027207 35.04555753 -19.78938645 32.80659949 -23.578125 28.71875 C-27.13749657 23.37969265 -26.78151279 17.4828524 -26.203125 11.28125 C-24.60392 6.37933903 -21.45575292 3.11633528 -17.203125 0.28125 C-11.84906913 -1.50343529 -5.40672306 -1.76389547 0 0 Z M-21.078125 8.40625 C-22.37462359 10.20264648 -22.37462359 10.20264648 -22.203125 12.28125 C-19.6942176 11.86309877 -17.58077289 11.48745523 -15.3359375 10.26171875 C-11.47205965 8.48546721 -7.36518103 8.82756617 -3.203125 9.28125 C0.234375 10.78125 0.234375 10.78125 2.796875 12.28125 C3.786875 12.28125 4.776875 12.28125 5.796875 12.28125 C4.44405331 7.85383356 2.56388612 5.91815779 -1.203125 3.28125 C-8.52514951 -0.37976226 -16.01406726 2.66698456 -21.078125 8.40625 Z M-18.203125 14.28125 C-21.078125 14.96875 -21.078125 14.96875 -23.203125 15.28125 C-23.203125 16.93125 -23.203125 18.58125 -23.203125 20.28125 C-22.49285156 20.34183594 -21.78257813 20.40242188 -21.05078125 20.46484375 C-20.13167969 20.54863281 -19.21257813 20.63242187 -18.265625 20.71875 C-16.89083984 20.84056641 -16.89083984 20.84056641 -15.48828125 20.96484375 C-13.203125 21.28125 -13.203125 21.28125 -12.203125 22.28125 C-11.97025492 23.96308948 -11.79048334 25.6524916 -11.640625 27.34375 C-11.55683594 28.26285156 -11.47304688 29.18195312 -11.38671875 30.12890625 C-11.32613281 30.83917969 -11.26554687 31.54945312 -11.203125 32.28125 C-9.223125 32.28125 -7.243125 32.28125 -5.203125 32.28125 C-5.11224609 31.21583984 -5.11224609 31.21583984 -5.01953125 30.12890625 C-4.93574219 29.20980469 -4.85195313 28.29070313 -4.765625 27.34375 C-4.68441406 26.42722656 -4.60320313 25.51070312 -4.51953125 24.56640625 C-4.203125 22.28125 -4.203125 22.28125 -3.203125 21.28125 C-1.52128552 21.04837992 0.1681166 20.86860834 1.859375 20.71875 C2.77847656 20.63496094 3.69757812 20.55117188 4.64453125 20.46484375 C5.35480469 20.40425781 6.06507812 20.34367187 6.796875 20.28125 C6.796875 18.63125 6.796875 16.98125 6.796875 15.28125 C6.17039062 15.07628906 5.54390625 14.87132812 4.8984375 14.66015625 C4.08117187 14.39074219 3.26390625 14.12132812 2.421875 13.84375 C1.60976563 13.57691406 0.79765625 13.31007813 -0.0390625 13.03515625 C-2.203125 12.28125 -2.203125 12.28125 -4.203125 11.28125 C-10.00013319 10.89478279 -13.04740612 11.41696173 -18.203125 14.28125 Z M-22.203125 22.28125 C-20.85678043 26.6874686 -19.00938126 28.71202702 -15.203125 31.28125 C-14.543125 31.28125 -13.883125 31.28125 -13.203125 31.28125 C-13.46706001 27.84894552 -13.46706001 27.84894552 -14.203125 24.28125 C-17.43104055 22.1293063 -18.48713309 22.08038557 -22.203125 22.28125 Z M-1.515625 23.96875 C-3.48856788 26.67241247 -3.56649662 28.01090541 -3.203125 31.28125 C1.2030936 29.93490543 3.22765202 28.08750626 5.796875 24.28125 C5.796875 23.62125 5.796875 22.96125 5.796875 22.28125 C2.52653041 21.91787838 1.18803747 21.99580712 -1.515625 23.96875 Z " fill="#E8E8E8" transform="translate(33.203125,7.71875)"/>
              <path d="M0 0 C5.56340585 3.36669624 9.53349183 8.25193794 11.5 14.4375 C12.30594257 22.2813829 12.59671889 30.02934467 7.5 36.4375 C3.04867668 41.14197914 -1.19064516 44.09747071 -7.76953125 44.7734375 C-16.04371997 44.8646634 -22.08428015 44.61560264 -28.2421875 38.7890625 C-34.17397269 32.28964236 -34.96296445 26.57688134 -34.80859375 17.88671875 C-34.22339005 11.3457711 -31.85547257 7.43687235 -27.0625 3.0625 C-19.84507341 -2.93248543 -8.52200107 -3.84066973 0 0 Z M-27.875 9 C-31.92136798 15.06955197 -32.41160223 20.18189038 -31.5 27.4375 C-29.19500637 33.34285558 -25.20255148 37.63684508 -19.5 40.41015625 C-13.7076757 42.73311964 -9.31507341 42.67575467 -3.5 40.4375 C2.09640718 37.37531494 6.03571356 33.35178747 8.5 27.4375 C9.44118685 20.50243899 9.13545046 14.7811783 4.9296875 9.0546875 C1.28946779 4.93706193 -2.72322316 1.81434829 -8.234375 1.06640625 C-16.98743204 0.87365758 -21.92082025 2.57575342 -27.875 9 Z " fill="#E8E8E8" transform="translate(36.5,3.5625)"/>
              <path d="M0 0 C3 0.25 3 0.25 5 2.25 C5.25 5.25 5.25 5.25 5 8.25 C3 10.25 3 10.25 0 10.5 C-3 10.25 -3 10.25 -5 8.25 C-5.25 5.25 -5.25 5.25 -5 2.25 C-3 0.25 -3 0.25 0 0 Z M-2 3.25 C-2 4.57 -2 5.89 -2 7.25 C-0.68 7.25 0.64 7.25 2 7.25 C2 5.93 2 4.61 2 3.25 C0.68 3.25 -0.64 3.25 -2 3.25 Z " fill="#E8E8E8" transform="translate(25,19.75)"/>
            </svg>
          </div>



        </ng-container>
      </div>

      <!-- Seat Legend - Show in both mobile and desktop views -->
      <div class="seat-legend-container mt-4" [@legendItem]>
        <div class="d-flex flex-wrap gap-2 gap-md-4 justify-content-center">
          <div class="d-flex align-items-center">
            <div class="seat-legend vip"></div>
            <span class="small">VIP</span>
          </div>
          <div class="d-flex align-items-center">
            <div class="seat-legend normal"></div>
            <span class="small">Normal</span>
          </div>
          <div class="d-flex align-items-center">
            <div class="seat-legend bclass"></div>
            <span class="small">Business</span>
          </div>
          <div class="d-flex align-items-center">
            <div class="seat-legend unavailable"></div>
            <span class="small">Booked</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Selected Seats Summary -->
  <div class="card shadow-none mt-3">
    <div class="card-body">
      <h5 class="card-title">Selected Seats</h5>
      <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center">
        <div class="selected-seats mb-2 mb-md-0">
          <ng-container *ngIf="selectedSeats.length > 0; else noSeats">
            <p class="mb-0">
              <span class="fw-bold">Seats:</span> {{ getSelectedSeatsString() }}
            </p>
            <p class="text-muted small mb-0">
              {{ getSeatTypesSummary() }}
            </p>
          </ng-container>
          <ng-template #noSeats>
            <p class="mb-0 text-muted">No seats selected</p>
          </ng-template>
        </div>
        <div class="price text-start text-md-end">
          <ng-container *ngIf="selectedSeats.length > 0">
            <p class="mb-0 fs-5 fw-bold">KES {{ calculateTotalPrice() }}</p>
            <p class="text-muted small mb-0">Total Amount</p>
          </ng-container>
        </div>
      </div>
      <form class="mt-3" [formGroup]="boardingForm" (ngSubmit)="submitForm()">
        <div class="row">
          <div class="col-sm-6">
            <div class="w-100 d-flex flex-column">
              <label for="boarding">Boarding Point</label>
              <p-select
                inputId="boarding"
                [options]="stages?.boarding"
                formControlName="boarding"
                optionLabel="name"
                placeholder="Select a boarding point"
                class="w-full"
              />
            </div>
          </div>

          <div class="col-sm-6 mt-2">
            <div class="w-100 d-flex flex-column">
              <label for="dropping">Dropping Point</label>
              <p-select
                inputId="dropping"
                [options]="stages?.dropping"
                formControlName="dropping"
                optionLabel="name"
                placeholder="Select a dropping point"
                class="w-full"
              />
            </div>
          </div>
        </div>

      </form>

      <div class="mt-3">
        <!-- Scenario 1: Proceed to Checkout (One-Way or Final Step in Two-Way) -->
        <button
          *ngIf="selectedSeats.length > 0 && !boardingForm.invalid && (type === 'onward' || isReturnStep)"
          class="btn btn-primary w-100"
          (click)="proceedToCheckout()">
          Proceed to Checkout
          <i class="bi bi-arrow-right ms-2"></i>
        </button>

        <!-- Scenario 2: Proceed to Return (For Two-Way Trips, Onward Step) -->
        <button
          *ngIf="selectedSeats.length > 0 && !boardingForm.invalid && type === 'twoway' && !isReturnStep"
          class="btn btn-success w-100"
          (click)="proceedToReturn()">
          Proceed to Return
          <i class="bi bi-arrow-repeat ms-2"></i>
        </button>

        <!-- Scenario 3: Form Incomplete (Seats Selected but Form Invalid) -->
        <button
          *ngIf="selectedSeats.length > 0 && boardingForm.invalid"
          class="btn btn-warning w-100"
          disabled>
          Complete Form to Proceed
          <i class="bi bi-exclamation-triangle-fill ms-2"></i>
        </button>
        <!-- Scenario 4: No Seats Selected -->
        <button
          *ngIf="selectedSeats.length === 0"
          class="btn btn-secondary w-100"
          disabled>
          Select at least one seat
          <i class="bi bi-exclamation-circle-fill ms-2"></i>
        </button>
      </div>

      <!-- <div class="mt-2">
        <ng-container *ngIf="selectedSeats.length > 0; else blockButton">
          <button class="btn btn-primary w-100" [disabled]="selectedSeats.length === 0 || boardingForm.invalid" (click)="proceedToCheckout()">
            Proceed to Checkout
            <i class="bi bi-arrow-right ms-2"></i>
          </button>
        </ng-container>
        <ng-template #blockButton>
          <button class="btn btn-secondary w-100" disabled>
            Select at least one seat
            <i class="bi bi-exclamation-circle-fill ms-2"></i>
          </button>
        </ng-template>
      </div> -->
    </div>
  </div>
</div>

