<!-- Loading State -->
<div *ngIf="isLoading" class="d-flex justify-content-center align-items-center py-5">
  <div class="text-center">
    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
      <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-3 text-muted fs-5">Searching for available buses...</p>
    <small class="text-muted">This may take a few moments</small>
  </div>
</div>

<!-- Empty State -->
<div *ngIf="!isLoading && isEmpty" class="text-center py-5">
  <div class="mb-4">
    <i class="bi bi-bus-front fa-3x text-muted mb-3" style="font-size: 4rem;"></i>
    <h4 class="text-muted mb-3">No buses available</h4>
    <p class="text-muted mb-4">
      We couldn't find any buses for your selected route and date.<br>
      Try adjusting your search criteria or check back later.
    </p>
  </div>
</div>

<!-- Bus Results Content -->
<div *ngIf="!isLoading && !isEmpty">
  <div *ngFor="let item of buses; let i = index">
    <div
      (click)="getSelectedBus(item)"
      [ngClass]="collapseState[i] ? 'bg-white' : 'card-selected'"
      class="d-flex flex-column d-md-none p-3 card rounded-4 shadow-sm m-2 position-relative"
      style="min-width:300px">

      <!-- Highway Badge -->
      <div class="highwayPatch text-center" *ngIf="item.highWayDirectRoute === 'Highway'">Highway</div>

      <!-- Main Content Container -->
      <div class="d-flex flex-column gap-2">
        <img src="assets/WEBP/logo.webp" height="112.5" width="75"
             [ngClass]="item.highWayDirectRoute === 'Highway' ? 'ms-4':''"
             class="img-thumbnail border-0 text-end" alt="logo">


        <!-- Time and Price Row -->
        <div class="d-flex justify-content-between align-items-start pt-2">
          <!-- Time Section -->
          <div>
            <div class="d-flex align-items-center gap-2 mb-1">
              <span style="font-size: 15px" class="fw-semibold mb-0 text-dark">{{ item.departure_time }}</span>
              <span class="text-muted mx-2">—</span>
              <span style="font-size: 15px" class="mb-0 text-muted">{{ item.arrival_time }}</span>
            </div>
            <div class="text-info-emphasis small">
              <span
                style="font-size: 14px"
                *ngFor="let schedule of item.defaultTripPriceList; let last = last">
                ( {{ schedule.seatType }} : {{ schedule.amount | number }} {{ !last ? ', ' : '' }})
              </span>
            </div>
          </div>
          <!-- Price Section -->
          <div class="text-end">
            <div class="h5 fw-bold mb-0 text-dark">
              <span style="font-size: 10px; margin-right:4px">KSH</span>
              {{ getPreferredAmount(item) | number }}
            </div>
            <div class="small mb-1">
              {{ getPreferredSeat(item)?.seatType | uppercase }}
            </div>
          </div>
        </div>

        <!-- Company Info Row -->
        <div class="d-flex justify-content-between align-items-center">
          <!-- Company Details -->
          <div class="d-flex align-items-center">
            <div>
              <div class="d-flex align-items-center gap-2 mb-1">
                <span class="fw-semibold text-dark" style="font-size: 14px">{{ item.company_name }}</span>
                <span *ngIf="item.verified" class="text-success">
                  <i class="bi bi-shield-check" style="font-size: 14px"></i>
                </span>
              </div>
              <div class="small text-muted">
                {{ item.highWayDirectRoute }} • {{ item.busType || 'A/C Sleeper' }}
                <span *ngIf="item.amenities?.length" class="ms-1">({{ item.amenities.length }}+)</span>
              </div>
            </div>
          </div>

          <!-- Rating -->
          <div class="d-flex align-items-center gap-1">
            <span class="badge text-white d-flex align-items-center gap-1 px-2 py-1"
                  style="background-color: #28a745; border-radius: 4px">
              ★ {{ item.avg_rating || '4.3' }}
            </span>
          </div>
        </div>

        <!-- Action Button -->
        <div class="d-flex justify-content-end">
          <button
            (click)="toggleCollapse(i); searchSeats(item, i); $event.stopPropagation()"
            [attr.aria-expanded]="!collapseState[i]"
            [ngClass]="collapseState[i] ? 'btn-primary' : 'btn-outline-secondary'"
            [disabled]="isLoadingSeats[i]"
            class="btn btn-sm px-4 position-relative rounded-4">

            <!-- Loading spinner -->
            <span *ngIf="isLoadingSeats[i]" class="spinner-border spinner-border-sm me-2" role="status">
              <span class="visually-hidden">Loading...</span>
            </span>

            <!-- Button text -->
            <span *ngIf="!isLoadingSeats[i]">
              {{ collapseState[i] ? 'View Seats' : 'Close' }}
            </span>
            <span *ngIf="isLoadingSeats[i]">
              Loading...
            </span>
          </button>
        </div>
      </div>
    </div>

    <!-- Seat Selection Drawer -->
    <p-drawer header="Seat Selection"
              [(visible)]="visibleState[i]"
              position="bottom"
              (onHide)="toggleCollapse(i)"
              [style]="{ height: '800px' }">

      <!-- Loading state for seat selection -->
      <div *ngIf="isLoadingSeats[i]" class="d-flex justify-content-center align-items-center py-5" style="height: 800px">
        <div class="text-center">
          <div class="spinner-border text-primary" role="status" style="width: 2.5rem; height: 2.5rem;">
            <span class="visually-hidden">Loading seats...</span>
          </div>
          <p class="mt-3 text-muted">Loading available seats...</p>
          <small class="text-muted">Please wait while we fetch seat information</small>
        </div>
      </div>

      <!-- Error state for seat loading -->
      <div *ngIf="!isLoadingSeats[i] && seatLoadError[i]" class="text-center py-5">
        <div class="mb-4">
          <i class="bi bi-exclamation-triangle text-warning" style="font-size: 3rem;"></i>
          <h5 class="text-muted mt-3">Failed to load seats</h5>
          <p class="text-muted">Something went wrong while loading seat information.</p>
          <button class="btn btn-outline-primary" (click)="reloadSeats(item, i)">
            <i class="bi bi-arrow-clockwise me-2"></i>
            Try Again
          </button>
        </div>
      </div>

      <!-- Seat selector content -->
      <div *ngIf="!isLoadingSeats[i] && !seatLoadError[i]"
           style="overflow-x: hidden; overflow-y: scroll;" class="py-4">
        <div #collapse="ngbCollapse" [(ngbCollapse)]="collapseState[i]" class="m-1 col-12 d-lg-none">
          <div class="rounded">
            <div class="row g-3 mx-0">
              <div class="col-12">
                <div>
                  <!-- Seat selector component -->
                  <app-component-bus-seat-selector
                    *ngIf="seat_data"
                    [payload]="seat_data"
                    (close)="closeDrawerFromEmmiter($event, i)"
                    [current]="i"
                    [type]="type">
                  </app-component-bus-seat-selector>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Close button -->
      <div class="text-end pb-2 my-4">
        <button class="btn btn-sm btn-outline-primary" (click)="toggleCollapse(i)">
          <i class="bi bi-chevron-bar-up me-1"></i>
          <span>Close</span>
        </button>
      </div>
    </p-drawer>
  </div>
</div>
